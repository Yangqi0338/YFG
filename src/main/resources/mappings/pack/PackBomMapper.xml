<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.base.sbc.module.pack.mapper.PackBomMapper">
    <!--
        资料包-物料清单
        创建人：lxl
        邮箱：lxl.fml@gmail.com
        创建时间：2023-7-1 16:37:22
        版本号：1.0
      -->

    <!-- ***********************自定义方法区 不替换的区域【other_start】***************************************** -->

    <select id="getBomIdsByVersionId" resultType="java.lang.String">
        select id
        from t_pack_bom
        where bom_version_id = #{bomVersionId}
    </select>

    <select id="fabricSummaryList" parameterType="com.base.sbc.module.sample.dto.FabricSummaryDTO" resultType="com.base.sbc.module.sample.vo.FabricSummaryVO">
        SELECT
            *
        FROM
            (
            SELECT
                bc.id AS color_id,
                b.id AS book_id,
                bc.order_book_code,
                bc.style_no,
        t2.design_no,
        b.meet_flag,
        b.lock_flag
        FROM
        t_sample_style_order_book_color bc
        LEFT JOIN t_sample_style_order_book b ON bc.order_book_code = b.order_book_code
        LEFT JOIN t_sample_style_group sg ON bc.style_no = sg.style_no
        AND sg.del_flag = '0'
        LEFT JOIN t_style_color t1 ON bc.style_no = t1.style_no
        AND t1.del_flag = '0'
        LEFT JOIN t_style t2 ON t1.design_no = t2.design_no
        AND t2.del_flag = '0'
        WHERE
        bc.del_flag = '0'
        AND b.meet_flag = '1'  AND bc.company_code = #{companyCode} AND b.company_code = #{companyCode}
        ) cbgcd
        LEFT JOIN (
        SELECT
        pb.material_id AS id,
        pb.material_name,
        bm.image_url,
                bm.category_name,
                bm.supplier_id,
                bm.supplier_name,
                pb.supplier_material_code,
                pb.material_code,
                bm.factory_composition,
                pb.part_code,
                pb.part_name,
                bm.translate,
                pb.color,
                pb.remarks,
                bm.purchase_unit_name,
                pb.price,
                pb.loss_rate,
        pb.cost,
        pb.supplier_price,
        sd.design_no AS design_no_two,
        sd.month,
        sd.band_code
        FROM
        t_pack_bom pb
        LEFT JOIN t_basicsdatum_material bm ON bm.id = pb.material_id
        LEFT JOIN t_pack_info pi ON pi.id = pb.foreign_id
        AND pi.del_flag = '0'
        LEFT JOIN t_style sd ON sd.id = pi.foreign_id
        AND sd.del_flag = '0'
        WHERE
        pb.pack_type = 'packDesign'
        AND pb.company_code = #{companyCode}
        AND pb.del_flag = '0'
        ) bid ON cbgcd.design_no = bid.design_no_two
        WHERE
             bid.material_code IS NOT NULL
        <if test="null != search and '' != search">
            AND (bid.material_code LIKE  concat('%',#{search},'%') OR bid.material_name LIKE  concat('%',#{search},'%'))
        </if>
        <if test="null != month and '' != month">
            AND  bid.month = #{month}
        </if>
        <if test="null != bandCode and '' != bandCode">
            AND  bid.band_code = #{bandCode}
        </if>
        <if test="null != monthList">
            AND  bid.month  in
            <foreach collection="monthList" item=" month" separator="," open="(" close=")">
                #{ month}
            </foreach>
        </if>
        <if test="bandList != null and bandList.size != 0">
            AND bid.band_code in
            <foreach collection="bandList" item="bandCode" separator="," open="(" close=")">
                #{bandCode}
            </foreach>
        </if>
        GROUP BY
            bid.material_code
    </select>

    <select id="querySampleDesignInfoByMaterialId" resultType="com.base.sbc.module.sample.vo.MaterialSampleDesignVO">
        SELECT
            ssc.id,
            uf.url,
            sd.band_code,
            b.band_name,
            ssc.category_name,
            ssc.style_no,
            ssc.design_no,
            ssc.color_name,
            ssc.color_specification,
            ssc.sales_type,
            ssc.is_trim,
            ssc.principal_style
        FROM t_style_color ssc
                 LEFT JOIN t_style sd ON sd.id = ssc.style_id
                 LEFT JOIN t_upload_file uf ON uf.id = sd.style_pic
                 LEFT JOIN t_basicsdatum_band b ON b.CODE = sd.band_code
                 LEFT JOIN (SELECT sd.design_no AS design_no_two,
                                   pi.style_no,
                                   pb.material_id
                            FROM t_pack_bom pb
                                     LEFT JOIN t_pack_info pi ON pi.id = pb.foreign_id
                                AND pi.del_flag = '0'
                                     LEFT JOIN t_style sd ON sd.id = pi.foreign_id
                                AND sd.del_flag = '0'
                            WHERE pb.pack_type = 'packDesign'
                              AND pb.del_flag = '0'
                            GROUP BY pb.material_code) AS bmid ON bmid.design_no_two = sd.design_no
        WHERE ssc.del_flag = '0' AND ssc.company_code = #{companyCode}
          AND bmid.material_id = #{materialId}
    </select>

    <select id="getPricingMaterialCostsByForeignId" resultType="com.base.sbc.module.pricing.vo.PricingMaterialCostsVO">
        SELECT
            id AS sourceId,
            category_name AS categoryName,
            supplier_id AS supplierId,
            supplier_name AS supplierName,
            part AS part,
            material_name AS materialsName,
            material_code AS materialsCode,
            translate AS width,
            unit_use AS unitNum,
            unit_code AS unitCode,
            loss_rate AS lossRate,
            rated_unit_consumption AS ratedUnitConsumption,
            purchase_currency AS purchaseCurrency,
            price AS price,
            last_time_price AS lastTimePrice,
            contacts AS contacts,
            contacts_phone AS contactsPhone,
            contacts_address AS contactsAddress,
            workshop_group_code AS workshopGroupCode,
            workshop_group AS workshopGroup
        FROM
            t_pack_bom
        WHERE
            del_flag = '0'
          AND foreign_id = #{foreignId}
    </select>

    <select id="getPackBomCalculateBaseVo" resultType="com.base.sbc.module.pack.vo.PackBomCalculateBaseVo">
        SELECT
            pb.bulk_unit_use,
            pb.bulk_price,
            pb.loss_rate,
            pb.amount,
            pb.price_tax,
            pb.foreign_id,
            pbv.pack_type
        FROM
            t_pack_bom pb
        JOIN t_pack_bom_version pbv ON pbv.id = pb.bom_version_id
        WHERE
        pbv.foreign_id IN
        <foreach collection="foreignIds" item="id" separator="," open="(" close=")">
            #{id}
        </foreach>
        AND pbv.del_flag = '0'
        AND pbv.STATUS = '1'
        AND unusable_flag = 0
    </select>
    <select id="countByVersion" resultType="java.lang.Long">
        select count(id)
        from t_pack_bom
        where bom_version_id = #{bomVersionId}
    </select>


    <!-- ***********************自定义方法区 不替换的区域【other_end】******************************************** -->
</mapper>