<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.base.sbc.module.patternlibrary.mapper.PatternLibraryMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.base.sbc.module.patternlibrary.entity.PatternLibrary">
        <id column="serial_number" property="serialNumber"/>
        <id column="id" property="id"/>
        <result column="code" property="code"/>
        <result column="design_no" property="designNo"/>
        <result column="style_id" property="styleId"/>
        <result column="prod_category1st" property="prodCategory1st"/>
        <result column="prod_category1st_name" property="prodCategory1stName"/>
        <result column="prod_category" property="prodCategory"/>
        <result column="prod_category_name" property="prodCategoryName"/>
        <result column="prod_category2nd" property="prodCategory2nd"/>
        <result column="prod_category2nd_name" property="prodCategory2ndName"/>
        <result column="prod_category3rd" property="prodCategory3rd"/>
        <result column="prod_category3rd_name" property="prodCategory3rdName"/>
        <result column="silhouette_code" property="silhouetteCode"/>
        <result column="silhouette_name" property="silhouetteName"/>
        <result column="template_code" property="templateCode"/>
        <result column="file_id" property="fileId"/>
        <result column="material_code" property="materialCode"/>
        <result column="material_name" property="materialName"/>
        <result column="pic_id" property="picId"/>
        <result column="pic_url" property="picUrl"/>
        <result column="status" property="status"/>
        <result column="enable_flag" property="enableFlag"/>
        <result column="create_id" property="createId"/>
        <result column="create_name" property="createName"/>
        <result column="create_date" property="createDate"/>
        <result column="update_id" property="updateId"/>
        <result column="update_name" property="updateName"/>
        <result column="update_date" property="updateDate"/>
        <result column="del_flag" property="delFlag"/>
        <result column="company_code" property="companyCode"/>
    </resultMap>

    <select id="listPages" resultType="com.base.sbc.module.patternlibrary.vo.PatternLibraryVO">
        SELECT
        tpl.serial_number, tpl.id, tpl.`code`, tpl.design_no, tpl.style_id, tpl.brand, tpl.brand_name,
        tpl.prod_category1st,tpl.prod_category1st_name, tpl.prod_category, tpl.prod_category_name,
        tpl.prod_category2nd,tpl.prod_category2nd_name, tpl.prod_category3rd, tpl.prod_category3rd_name,
        tpl.silhouette_code,tpl.silhouette_name, tpl.template_code, tpl.file_id, tpl.material_code,
        tpl.material_name, tpl.pic_id, tpl.pic_url, tpl.`status`, tpl.enable_flag, tpl.create_id, tpl.create_name,
        tpl.create_date,tpl.update_name, tpl.update_date, tpl.del_flag, tpl.company_code
        FROM t_pattern_library tpl
        LEFT JOIN t_pattern_library_item tpli ON tpli.pattern_library_id = tpl.id
        AND tpli.del_flag = '0'
        LEFT JOIN t_pattern_library_brand tplb ON tplb.pattern_library_id = tpl.id
        WHERE
        tpl.del_flag = '0'
        <if test="patternLibraryPageDTO.partsCodeList != null and patternLibraryPageDTO.partsCodeList.size > 0">
            AND tpli.code IN
            <foreach collection="patternLibraryPageDTO.partsCodeList" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        <if test="patternLibraryPageDTO.brand != null and patternLibraryPageDTO.brand.size > 0">
            AND tplb.brand IN
            <foreach collection="patternLibraryPageDTO.brand" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        <if test="ew.customSqlSegment != null and ew.customSqlSegment != ''">
            ${ ew.customSqlSegment.startsWith("WHERE")?ew.customSqlSegment.replace("WHERE","AND "):ew.customSqlSegment}
        </if>
        GROUP BY tpl.id
    </select>
    <select id="listStyle" resultType="com.base.sbc.module.style.entity.Style">
        SELECT
        s.*
        FROM t_style s
        <where>
            not EXISTS(select 1 from t_pattern_library tpl where tpl.style_id = s.id
            AND tpl.del_flag = '0')
            <if test="ew.customSqlSegment != null and ew.customSqlSegment != ''">
                ${ ew.customSqlSegment.startsWith("WHERE")?ew.customSqlSegment.replace("WHERE","AND "):ew.customSqlSegment}
            </if>
        </where>
    </select>

</mapper>
